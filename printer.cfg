# This file contains common pin mappings for the BigTreeTech Octopus V1.
# To use this config, the firmware should be compiled for the STM32F446 with a "32KiB bootloader"
# Enable "extra low-level configuration options" and select the "12MHz crystal" as clock reference

# after running "make", copy the generated "klipper/out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the OctoPus with that SD card.

# See docs/Config_Reference.md for a description of parameters.

## Voron Design Trident 300 BigTreeTech OctoPus V1 TMC2209 UART config


####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################

[include TEST_SPEED.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include config_backup.cfg]
[include BTT_2209_canbus.cfg]
[include stealthburner_leds.cfg] 
[include nevermore.cfg]
[include KNOMI.cfg] 
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
[include mmu/addons/Trident_blobifier.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]


[exclude_object]

[gcode_arcs]

####################################################################
#                        Octopus CONFIGS                           #
####################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_34002D000150335331383520-if00
restart_method: command

[printer]
kinematics: corexy
max_velocity: 400  
max_accel: 10000             
max_z_velocity: 25        
max_z_accel: 60
square_corner_velocity: 5.0

#[firmware_retraction]
#retract_length: 0.93
#retract_speed: 35
#unretract_extra_length: 0.00
#unretract_speed: 35

#####################################################################
#   ADXL345 Settings
#####################################################################

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 150, 152, 40
accel_chip: adxl345

#[resonance_tester]
#accel_chip: beacon
#probe_points: 90, 90, 20

####################################################################
#                     TEMPERATURE SENSORS                          #
####################################################################

[temperature_sensor BTT_Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi4B]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  
endstop_pin: ^PG6
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 45   
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: False
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400 
endstop_pin: ^PG9
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 45  
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: False
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0
 
#####################################################################
#   Z Stepper Settings
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_6C7F5F184E5737374D202020FF0A2B27-if00
x_offset: 0  # update with offset from nozzle on your machine
y_offset: 20 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
contact_max_hotend_temperature: 180 # increase to probe at print temps

home_xy_position: 150, 150 # update with your safe position
home_z_hop: 5
home_z_hop_speed: 30
home_xy_move_speed: 300
home_method: contact # use proximity for induction homing
home_method_when_homed: proximity # after initial calibration use induction
home_autocalibrate: unhomed # contact will calibrate beacon on first home


##  Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
#endstop_pin: PG10
endstop_pin: probe:z_virtual_endstop # use beacon as virtual endstop
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop: 0
position_max: 290
position_min: -5
homing_speed: 8.0 
second_homing_speed: 3
homing_retract_dist: 0             # beacon needs this to be set to 0  

[tmc2209 stepper_z]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Center
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 4  
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Front Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 4  
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#   TMC AUTOTUNE
#####################################################################

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2004mah
#resistance: 1.4
#inductance: 0.002
#holding_torque: 0.44
#max_current: 2.0
#steps_per_revolution: 400

#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2004mah
#resistance: 1.4
#inductance: 0.002
#holding_torque: 0.44
#max_current: 2.0
#steps_per_revolution: 400

#[autotune_tmc stepper_z]
#motor: ldo-42sth40-1684cl350et
#resistance: 1.65
#inductance: 0.0041
#holding_torque: 0.45
#max_current: 1.68
#steps_per_revolution: 200

#[autotune_tmc stepper_z1]
#motor: ldo-42sth40-1684cl350et
#resistance: 1.65
#inductance: 0.0041
#holding_torque: 0.45
#max_current: 1.68
#steps_per_revolution: 200

#[autotune_tmc stepper_z2]
#motor: ldo-42sth40-1684cl350et
#resistance: 1.65
#inductance: 0.0041
#holding_torque: 0.45
#max_current: 1.68
#steps_per_revolution: 200

#####################################################################
#   Extruder
#####################################################################

## BTT EBB2209 CanBus Toolhead

#####################################################################
#   Bed Heater
#####################################################################

[idle_timeout]
timeout: 1800

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
max_power: 0.70
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 25,25
mesh_max: 275,275
zero_reference_position: 150,150

#####################################################################
#   Fan Control
#####################################################################

[temperature_fan board_fan]
pin: PD12
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.8
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.1
max_speed: 0.6
target_temp: 42

#####################################################################
#   LED Control
#####################################################################

[output_pin caselight]
## Chamber Lighting - FAN5
pin: PD15
pwm:true
shutdown_value: 0
value:0.4
cycle_time: 0.01

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
#home_xy_position: 150,150
#speed:300
#z_hop:10

[z_tilt]

z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 5
   150, 245
   270, 5
speed: 200
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 41.109
#*# pid_ki = 15.225
#*# pid_kd = 27.749
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 42.616
#*# pid_ki = 1.464
#*# pid_kd = 310.031
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 56.0
#*# shaper_type_y = mzv
#*# shaper_freq_y = 42.8
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.065817, 0.060948, 0.042152, 0.028744, 0.019515, 0.017715, 0.017525, 0.014068, 0.011320, 0.007801, 0.011470, 0.014619, 0.020745, 0.027058, 0.027960, 0.041848, 0.047928, 0.062461, 0.060736, 0.062097
#*# 	  0.095634, 0.089553, 0.070495, 0.055758, 0.043045, 0.037984, 0.034836, 0.031299, 0.028906, 0.022566, 0.023291, 0.025996, 0.031634, 0.040093, 0.045143, 0.056410, 0.062679, 0.073211, 0.073873, 0.074801
#*# 	  0.116360, 0.103695, 0.083429, 0.067031, 0.060332, 0.054384, 0.051580, 0.042886, 0.038377, 0.029773, 0.031746, 0.033513, 0.041243, 0.046788, 0.051214, 0.062763, 0.064704, 0.073464, 0.073964, 0.075109
#*# 	  0.123657, 0.109532, 0.094311, 0.078695, 0.066427, 0.062391, 0.059373, 0.050056, 0.041832, 0.032018, 0.030929, 0.034728, 0.040928, 0.050396, 0.049572, 0.061406, 0.068863, 0.072243, 0.073273, 0.072942
#*# 	  0.129184, 0.114948, 0.093562, 0.078063, 0.073016, 0.066041, 0.062682, 0.053655, 0.045139, 0.034905, 0.032320, 0.036847, 0.044160, 0.050380, 0.053443, 0.067466, 0.067266, 0.072734, 0.067811, 0.065925
#*# 	  0.129900, 0.117075, 0.096661, 0.089988, 0.077323, 0.069522, 0.063834, 0.055220, 0.046569, 0.034653, 0.033662, 0.037845, 0.043977, 0.050798, 0.052745, 0.061802, 0.067154, 0.071152, 0.060378, 0.051963
#*# 	  0.125844, 0.114057, 0.097212, 0.089347, 0.072826, 0.066379, 0.060928, 0.047565, 0.039675, 0.028146, 0.023320, 0.027908, 0.035006, 0.038187, 0.038405, 0.049160, 0.053460, 0.057001, 0.045740, 0.035711
#*# 	  0.120352, 0.106146, 0.087561, 0.074517, 0.063820, 0.059612, 0.049460, 0.040134, 0.028865, 0.017547, 0.011484, 0.019150, 0.022459, 0.024205, 0.027634, 0.040203, 0.041451, 0.038616, 0.031256, 0.020828
#*# 	  0.115406, 0.099754, 0.080724, 0.070290, 0.058003, 0.051637, 0.043344, 0.028699, 0.020367, 0.007252, 0.003569, 0.007271, 0.010415, 0.017432, 0.014199, 0.021116, 0.022928, 0.020127, 0.010044, 0.005369
#*# 	  0.116586, 0.099957, 0.076163, 0.063489, 0.054059, 0.044079, 0.034491, 0.025850, 0.013663, 0.002142, 0.001093, -0.000882, 0.000941, 0.005899, 0.008088, 0.013847, 0.010879, 0.008579, 0.002730, -0.002974
#*# 	  0.120947, 0.101692, 0.084435, 0.064933, 0.051743, 0.046203, 0.036379, 0.026059, 0.013589, 0.002884, 0.002117, 0.002598, 0.002893, 0.003267, 0.003719, 0.015586, 0.009279, 0.007537, -0.002754, -0.008488
#*# 	  0.123609, 0.104580, 0.081784, 0.065871, 0.060002, 0.049276, 0.039370, 0.024597, 0.014299, 0.002217, 0.000784, 0.002149, 0.003399, 0.007656, 0.002374, 0.010098, 0.003690, 0.004244, -0.008442, -0.012946
#*# 	  0.133051, 0.111280, 0.086266, 0.067642, 0.058621, 0.050335, 0.039677, 0.029570, 0.014987, 0.002788, -0.002056, -0.000192, 0.002819, 0.001971, 0.001664, 0.001614, 0.004901, 0.002369, -0.008774, -0.020485
#*# 	  0.149970, 0.121373, 0.096321, 0.081264, 0.072769, 0.060343, 0.049982, 0.037725, 0.022904, 0.010738, 0.008444, 0.009442, 0.008135, 0.008632, 0.007191, 0.014173, 0.006087, 0.002025, -0.004268, -0.014007
#*# 	  0.172168, 0.138794, 0.114427, 0.095785, 0.085740, 0.075573, 0.064404, 0.046626, 0.031945, 0.019126, 0.017792, 0.014470, 0.017154, 0.018836, 0.012312, 0.008942, 0.013388, 0.011388, 0.007158, -0.004125
#*# 	  0.180483, 0.153779, 0.125706, 0.107077, 0.099980, 0.085039, 0.076495, 0.053175, 0.039309, 0.027457, 0.023269, 0.023232, 0.022402, 0.018198, 0.013283, 0.009352, 0.014493, 0.011559, 0.005282, 0.000027
#*# 	  0.198326, 0.168869, 0.144636, 0.123684, 0.113446, 0.100742, 0.086324, 0.068449, 0.053137, 0.039398, 0.033895, 0.030774, 0.029799, 0.024513, 0.019526, 0.018746, 0.013973, 0.017419, 0.010478, 0.004344
#*# 	  0.214241, 0.189920, 0.164028, 0.146664, 0.134937, 0.123107, 0.107262, 0.088015, 0.071003, 0.057174, 0.050228, 0.048015, 0.041430, 0.037131, 0.032586, 0.029079, 0.029667, 0.026507, 0.021395, 0.014977
#*# 	  0.231540, 0.209370, 0.184731, 0.167605, 0.154703, 0.141108, 0.123638, 0.100339, 0.082850, 0.066680, 0.060949, 0.063237, 0.056597, 0.047461, 0.037144, 0.046941, 0.040482, 0.038538, 0.029350, 0.023170
#*# 	  0.237754, 0.209660, 0.189575, 0.176366, 0.162457, 0.149589, 0.130524, 0.105811, 0.084165, 0.071592, 0.063412, 0.067199, 0.058997, 0.053484, 0.042943, 0.039994, 0.032835, 0.032658, 0.027876, 0.017864
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 275.0
#*# min_y = 25.0
#*# max_y = 275.0
#*#
#*# [stepper_z]
#*# position_endstop = 2.130
#*#
#*# [beacon model default]
#*# model_coef = 1.7845022865569424,
#*# 	  2.0420965860558096,
#*# 	  0.6372273505926938,
#*# 	  0.26363553961389435,
#*# 	  0.17723992117000875,
#*# 	  0.13749058148872514,
#*# 	  -0.05381882632498522,
#*# 	  -0.08570579988160129,
#*# 	  0.057730579281644975,
#*# 	  0.04682990481175491
#*# model_domain = 1.9302766200305198e-07,1.9537663570073619e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 52.409207
#*# model_offset = 0.00000
